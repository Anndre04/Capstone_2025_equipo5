{% extends 'base.html' %}
{% load static %}
{% block title %}Gestor Tutor칤as - Tutor칤as Online{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 px-lg-5 py-4">
  
  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h1 class="h2 mb-2 fw-bold text-dark">Gestor de Tutor칤as</h1>
          <p class="text-muted mb-0">Administra tus tutor칤as aceptadas</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SELECTORES -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row g-3 align-items-end">
            <!-- TUTORIA -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Anuncio</label>
              <select class="form-select border" id="selectAnuncio">
                <option value="">Selecciona Anuncio</option>
                {% for solicitud in solicitudes %}
                  {% if solicitud.anuncio %}
                    <option value="{{ solicitud.anuncio.id }}">
                      {{ solicitud.anuncio.titulo }}
                    </option>
                  {% endif %}
                {% empty %}
                  <option value="">No hay anuncios disponibles</option>
                {% endfor %}
              </select>
            </div>

            <!-- SOLICITUDES -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Solicitud</label>
              <!-- 游댳 Inicialmente deshabilitado -->
              <select class="form-select border" id="selectSolicitud">
                <option value="">Selecciona Solicitud</option>
              </select>
            </div>

            <!-- BOT칍N -->
            <div class="col-12 col-md-4">
              <button class="btn btn-primary w-100" id="btnIniciar">
                <i class="bi bi-camera-video me-2"></i>Iniciar Tutoria
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIDEOCALL & CHAT SECTION -->
  <div class="row g-4 d-none" id="videocallSection">
    <div class="col-12 col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Videollamada</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-light" id="btnToggleMic">
              <i class="bi bi-mic-fill"></i>
            </button>
            <button class="btn btn-sm btn-light" id="btnToggleCam">
              <i class="bi bi-camera-video-fill"></i>
            </button>
            <button class="btn btn-sm btn-danger" id="btnEndCall">
              <i class="bi bi-telephone-fill"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-0 position-relative">
          <!-- Video local -->
          <div class="position-absolute top-0 end-0 m-3 z-1" style="width: 200px; height: 150px;">
            <video id="localVideo" autoplay muted class="w-100 h-100 rounded shadow-sm bg-dark"></video>
            <div class="position-absolute bottom-0 start-0 bg-dark bg-opacity-75 text-white px-2 py-1 small rounded-top-end">
              T칰
            </div>
          </div>
          
          <!-- Video remoto -->
          <div class="w-100 h-100 min-vh-50 bg-dark bg-opacity-10 d-flex align-items-center justify-content-center">
            <video id="remoteVideo" autoplay class="w-100 h-100" style="max-height: 500px;"></video>
            <div id="waitingMessage" class="text-center text-muted p-4">
              <i class="bi bi-camera-video-off display-4 d-block mb-3"></i>
              <h5>Esperando conexi칩n...</h5>
              <p>La videollamada se iniciar치 cuando el alumno se una</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-12 col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Chat</h5>
        </div>
        <div class="card-body p-0 d-flex flex-column">
          <!-- Mensajes del chat -->
          <div id="chatMessages" class="flex-grow-1 p-3" style="height: 300px; overflow-y: auto;">
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-dots display-6 d-block mb-2"></i>
              <p>El chat est치 listo para usar</p>
            </div>
          </div>
          
          <!-- Input para enviar mensajes -->
          <div class="border-top p-3">
            <div class="input-group">
              <input type="text" id="chatInput" class="form-control" placeholder="Escribe un mensaje..." disabled>
              <button class="btn btn-primary" id="btnSendMessage" disabled>
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TUTOR칈AS -->
  <div class="row g-4">
    <!-- Aqu칤 va el contenido adicional de tutor칤as si es necesario -->
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const selectAnuncio = document.getElementById("selectAnuncio");
    const selectSolicitud = document.getElementById("selectSolicitud");
    const btnIniciar = document.getElementById("btnIniciar");
    const videocallSection = document.getElementById("videocallSection");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const waitingMessage = document.getElementById("waitingMessage");
    const btnToggleMic = document.getElementById("btnToggleMic");
    const btnToggleCam = document.getElementById("btnToggleCam");
    const btnEndCall = document.getElementById("btnEndCall");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const btnSendMessage = document.getElementById("btnSendMessage");

    // Estados de la videollamada
    let localStream = null;
    let remoteStream = null;
    let isMicOn = true;
    let isCamOn = true;
    let isCallActive = false;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Inicialmente deshabilitado
    selectSolicitud.disabled = true;
    btnIniciar.disabled = true;

    selectAnuncio.addEventListener("change", async () => {
        const anuncioId = selectAnuncio.value;
        if (!anuncioId) {
            selectSolicitud.disabled = true;
            selectSolicitud.innerHTML = `<option value="">Selecciona Solicitud</option>`;
            return;
        }

        try {
            const response = await fetch(`/tutoria/obtener-alumnos/${anuncioId}/`);
            const data = await response.json();

            if (data.alumnos && data.alumnos.length > 0) {
                selectSolicitud.disabled = false;
                selectSolicitud.innerHTML = `
                    <option value="">Selecciona Solicitud</option>
                    ${data.alumnos.map(a => `<option value="${a.id}">${a.nombre} ${a.p_apellido} ${a.s_apellido}</option>`).join("")}
                `;
            } else {
                selectSolicitud.disabled = true;
                selectSolicitud.innerHTML = `<option value="">No hay solicitudes aprobadas</option>`;
            }
        } catch (err) {
            console.error("Error cargando solicitudes:", err);
            selectSolicitud.disabled = true;
            selectSolicitud.innerHTML = `<option value="">Error al cargar</option>`;
        }
    });

    function actualizarBoton() {
        btnIniciar.disabled = !(selectAnuncio.value && selectSolicitud.value);
    }

    selectAnuncio.addEventListener("change", actualizarBoton);
    selectSolicitud.addEventListener("change", actualizarBoton);

    // 游댳 Enviar solicitud
    btnIniciar.addEventListener("click", async () => {
        const anuncioId = selectAnuncio.value;
        const alumnoId = selectSolicitud.value;

        if (!anuncioId || !alumnoId) {
            Swal.fire({
                icon: "warning",
                title: "Faltan datos",
                text: "Selecciona un anuncio y un alumno antes de continuar"
            });
            return;
        }

        try {
            const response = await fetch("/tutoria/crear-solicitud-tutoria/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({
                    anuncio_id: anuncioId,
                    alumno_id: alumnoId
                })
            });

            const data = await response.json();

            if (data.success) {
                // 游댳 Mostrar modal en espera
                Swal.fire({
                    title: "Solicitud enviada",
                    html: `
                        <p class="fs-5 text-center">Esperando que el alumno responda...</p>
                        <div class="spinner-border text-primary mt-3" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        // Polling cada 2 segundos para verificar el estado
                        const interval = setInterval(async () => {
                            try {
                                const res = await fetch(`/tutoria/estado-solicitud/${data.solicitud_id}/`);
                                const estadoData = await res.json();

                                if (estadoData.estado === "Aceptada") {
                                    clearInterval(interval);
                                    Swal.fire({
                                        icon: "success",
                                        title: "춰Tutor칤a aceptada!",
                                        text: "El alumno ha aceptado la solicitud."
                                    }).then(() => {
                                        console.log(estadoData)
                                        window.location.href = `/tutoria/tutoria/${estadoData.tutoria_id}`;
                                    });
                                } else if (estadoData.estado === "Rechazada") {
                                    clearInterval(interval);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Tutor칤a rechazada",
                                        text: "El alumno ha rechazado la solicitud."
                                    });
                                }
                            } catch (e) {
                                console.error("Error consultando estado:", e);
                            }
                        }, 1000);
                    }
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.error || "No se pudo crear la solicitud"
                });
            }
        } catch (err) {
            console.error("Error enviando solicitud:", err);
            Swal.fire({
                icon: "error",
                title: "Error de red",
                text: "No se pudo enviar la solicitud"
            });
        }
    });

    // Funciones para la videollamada
    async function iniciarVideollamada() {
        try {
            // Mostrar la secci칩n de videollamada
            videocallSection.classList.remove("d-none");
            
            // Obtener acceso a la c치mara y micr칩fono
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            
            // Mostrar video local
            localVideo.srcObject = localStream;
            
            // Habilitar controles de chat
            chatInput.disabled = false;
            btnSendMessage.disabled = false;
            
            // Marcar llamada como activa
            isCallActive = true;
            
            // Aqu칤 ir칤a la l칩gica para conectar con el alumno
            // Por ahora simulamos una conexi칩n exitosa despu칠s de 3 segundos
            setTimeout(() => {
                waitingMessage.classList.add("d-none");
                remoteVideo.classList.remove("d-none");
                // En una implementaci칩n real, aqu칤 se conectar칤a con WebRTC
            }, 3000);
            
        } catch (error) {
            console.error("Error accediendo a los dispositivos multimedia:", error);
            Swal.fire({
                icon: "error",
                title: "Error de dispositivos",
                text: "No se pudo acceder a la c치mara o micr칩fono. Verifica los permisos."
            });
        }
    }

    // Control del micr칩fono
    btnToggleMic.addEventListener("click", () => {
        if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isMicOn = !isMicOn;
            btnToggleMic.innerHTML = isMicOn ? 
                '<i class="bi bi-mic-fill"></i>' : 
                '<i class="bi bi-mic-mute-fill"></i>';
            btnToggleMic.classList.toggle("btn-light", isMicOn);
            btnToggleMic.classList.toggle("btn-warning", !isMicOn);
        }
    });

    // Control de la c치mara
    btnToggleCam.addEventListener("click", () => {
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isCamOn = !isCamOn;
            btnToggleCam.innerHTML = isCamOn ? 
                '<i class="bi bi-camera-video-fill"></i>' : 
                '<i class="bi bi-camera-video-off-fill"></i>';
            btnToggleCam.classList.toggle("btn-light", isCamOn);
            btnToggleCam.classList.toggle("btn-warning", !isCamOn);
        }
    });

    // Finalizar llamada
    btnEndCall.addEventListener("click", () => {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        isCallActive = false;
        videocallSection.classList.add("d-none");
        
        // Restablecer controles
        btnToggleMic.innerHTML = '<i class="bi bi-mic-fill"></i>';
        btnToggleCam.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
        btnToggleMic.classList.add("btn-light");
        btnToggleCam.classList.add("btn-light");
        btnToggleMic.classList.remove("btn-warning");
        btnToggleCam.classList.remove("btn-warning");
        
        // Deshabilitar chat
        chatInput.disabled = true;
        btnSendMessage.disabled = true;
        
        Swal.fire({
            icon: "info",
            title: "Llamada finalizada",
            text: "La videollamada ha sido terminada."
        });
    });

    // Funcionalidad del chat
    btnSendMessage.addEventListener("click", enviarMensaje);
    chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            enviarMensaje();
        }
    });

    function enviarMensaje() {
        const mensaje = chatInput.value.trim();
        if (mensaje && isCallActive) {
            // Agregar mensaje al chat
            agregarMensaje("T칰", mensaje, true);
            
            // Limpiar input
            chatInput.value = "";
            
            // En una implementaci칩n real, aqu칤 se enviar칤a el mensaje al otro usuario
            // Por ahora simulamos una respuesta despu칠s de 1-3 segundos
            setTimeout(() => {
                const respuestas = [
                    "Entendido, gracias por la explicaci칩n.",
                    "쯇odr칤as repetir eso?",
                    "Claro, ahora lo veo m치s claro.",
                    "쯊ienes alg칰n ejemplo adicional?",
                    "Perfecto, gracias por la ayuda."
                ];
                const respuestaAleatoria = respuestas[Math.floor(Math.random() * respuestas.length)];
                agregarMensaje("Alumno", respuestaAleatoria, false);
            }, 1000 + Math.random() * 2000);
        }
    }
});
</script>

<script src="{% static 'js/js_tutoria/tutoria.js' %}"></script>
{% endblock %}