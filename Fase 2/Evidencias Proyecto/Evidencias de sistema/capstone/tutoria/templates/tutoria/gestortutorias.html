{% extends 'base.html' %}
{% load static %}
{% block title %}Gestor Tutor칤as - Tutor칤as Online{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 px-lg-5 py-4">
  
  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h1 class="h2 mb-2 fw-bold text-dark">Gestor de Tutor칤as</h1>
          <p class="text-muted mb-0">Administra tus tutor칤as aceptadas</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SELECTORES -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row g-3 align-items-end">
            <!-- TUTORIA -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Anuncio</label>
              <select class="form-select border" id="selectAnuncio">
                <option value="">Selecciona Anuncio</option>
                {% for solicitud in solicitudes %}
                  {% if solicitud.anuncio %}
                    <option value="{{ solicitud.anuncio.id }}">
                      {{ solicitud.anuncio.titulo }}
                    </option>
                  {% endif %}
                {% empty %}
                  <option value="">No hay anuncios disponibles</option>
                {% endfor %}
              </select>
            </div>

            <!-- SOLICITUDES -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Solicitud</label>
              <!-- 游댳 Inicialmente deshabilitado -->
              <select class="form-select border" id="selectSolicitud">
                <option value="">Selecciona Solicitud</option>
              </select>
            </div>

            <!-- BOT칍N -->
            <div class="col-12 col-md-4">
              <button class="btn btn-primary w-100" id="btnIniciar">
                <i class="bi bi-camera-video me-2"></i>Iniciar Tutoria
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const selectAnuncio = document.getElementById("selectAnuncio");
    const selectSolicitud = document.getElementById("selectSolicitud");
    const btnIniciar = document.getElementById("btnIniciar");

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Inicialmente deshabilitado
    selectSolicitud.disabled = true;
    btnIniciar.disabled = true;

    selectAnuncio.addEventListener("change", async () => {
        const anuncioId = selectAnuncio.value;
        if (!anuncioId) {
            selectSolicitud.disabled = true;
            selectSolicitud.innerHTML = `<option value="">Selecciona Solicitud</option>`;
            return;
        }

        try {
            const response = await fetch(`/tutoria/obtener-alumnos/${anuncioId}/`);
            const data = await response.json();

            if (data.alumnos && data.alumnos.length > 0) {
                selectSolicitud.disabled = false;
                selectSolicitud.innerHTML = `
                    <option value="">Selecciona Solicitud</option>
                    ${data.alumnos.map(a => `<option value="${a.id}">${a.nombre} ${a.p_apellido} ${a.s_apellido}</option>`).join("")}
                `;
            } else {
                selectSolicitud.disabled = true;
                selectSolicitud.innerHTML = `<option value="">No hay solicitudes aprobadas</option>`;
            }
        } catch (err) {
            console.error("Error cargando solicitudes:", err);
            selectSolicitud.disabled = true;
            selectSolicitud.innerHTML = `<option value="">Error al cargar</option>`;
        }
    });

    function actualizarBoton() {
        btnIniciar.disabled = !(selectAnuncio.value && selectSolicitud.value);
    }

    selectAnuncio.addEventListener("change", actualizarBoton);
    selectSolicitud.addEventListener("change", actualizarBoton);

    // 游댳 Enviar solicitud
    btnIniciar.addEventListener("click", async () => {
        const anuncioId = selectAnuncio.value;
        const alumnoId = selectSolicitud.value;

        if (!anuncioId || !alumnoId) {
            Swal.fire({
                icon: "warning",
                title: "Faltan datos",
                text: "Selecciona un anuncio y un alumno antes de continuar"
            });
            return;
        }

        try {
            const response = await fetch("/tutoria/crear-solicitud-tutoria/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({
                    anuncio_id: anuncioId,
                    alumno_id: alumnoId
                })
            });

            const data = await response.json();

            if (data.success) {
                // 游댳 Mostrar modal en espera
                Swal.fire({
                    title: "Solicitud enviada",
                    html: `
                        <p class="fs-5 text-center">Esperando que el alumno responda...</p>
                        <div class="spinner-border text-primary mt-3" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        // Polling cada 2 segundos para verificar el estado
                        const interval = setInterval(async () => {
                            try {
                                const res = await fetch(`/tutoria/estado-solicitud/${data.solicitud_id}/`);
                                const estadoData = await res.json();

                                if (estadoData.estado === "Aceptada") {
                                    clearInterval(interval);
                                    Swal.fire({
                                        icon: "success",
                                        title: "춰Tutor칤a aceptada!",
                                        text: "El alumno ha aceptado la solicitud."
                                    }).then(() => window.location.reload());
                                } else if (estadoData.estado === "Rechazada") {
                                    clearInterval(interval);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Tutor칤a rechazada",
                                        text: "El alumno ha rechazado la solicitud."
                                    });
                                }
                            } catch (e) {
                                console.error("Error consultando estado:", e);
                            }
                        }, 2000);
                    }
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.error || "No se pudo crear la solicitud"
                });
            }
        } catch (err) {
            console.error("Error enviando solicitud:", err);
            Swal.fire({
                icon: "error",
                title: "Error de red",
                text: "No se pudo enviar la solicitud"
            });
        }
    });
});
</script>



  <!-- TUTOR칈AS -->
  <div class="row g-4">
    
    <!-- TUTOR칈A -->
    <div class="col-12">
      <div class="card border-0 shadow-sm hover-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <!-- INFO -->
            <div class="col-12 col-lg-8">
              <div class="d-flex align-items-start mb-3">
                <div class="flex-shrink-0">
                  <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                       style="width: 48px; height: 48px;">
                    <i class="bi bi-calculator text-primary fs-6"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h5 class="card-title mb-2 fw-bold text-dark">Matem치ticas Avanzadas</h5>
                  <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary border-0">Ana Garc칤a</span>
                    <span class="badge bg-light text-muted border">8/12 sesiones</span>
                  </div>
                </div>
              </div>
              
              <!-- ESTUDIANTE -->
              <div class="row g-3 mb-3">
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-white d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                           style="width: 36px; height: 36px;">
                        <i class="bi bi-person text-muted fs-6"></i>
                      </div>
                      <div>
                        <strong class="fs-6 d-block">Ana Garc칤a</strong>
                        <small class="text-muted">Ing. Sistemas - 3er semestre</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- CONTACTO -->
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex flex-column">
                      <small class="d-flex align-items-center mb-1">
                        <i class="bi bi-envelope me-2 text-primary"></i>ana.garcia@email.com
                      </small>
                      <small class="d-flex align-items-center">
                        <i class="bi bi-star-fill me-2 text-warning"></i>4.5 
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ARCHIVOS -->
              <div class="pt-3 border-top">
                <h6 class="text-muted mb-3 small fw-semibold">Material</h6>
                <div class="d-flex flex-wrap gap-2">
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                    <small class="text-muted">Gu칤a_Algebra.pdf</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-text text-primary me-2"></i>
                    <small class="text-muted">Ejercicios.docx</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <!-- SUBIR -->
                  <div class="border rounded-3 p-2 d-flex align-items-center justify-content-center upload-btn bg-light" 
                       style="width: 44px; height: 44px; cursor: pointer;" 
                       onclick="subirArchivo()">
                    <i class="bi bi-plus-lg text-muted"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ACCIONES -->
            <div class="col-12 col-lg-4 mt-4 mt-lg-0">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-chat me-2"></i>Mensaje
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TUTOR칈A -->
    <div class="col-12">
      <div class="card border-0 shadow-sm hover-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <!-- INFO -->
            <div class="col-12 col-lg-8">
              <div class="d-flex align-items-start mb-3">
                <div class="flex-shrink-0">
                  <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                       style="width: 48px; height: 48px;">
                    <i class="bi bi-graph-up text-info fs-6"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h5 class="card-title mb-2 fw-bold text-dark">C치lculo Diferencial</h5>
                  <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary border-0">Carlos L칩pez</span>
                    <span class="badge bg-light text-muted border">5/10 sesiones</span>
                  </div>
                </div>
              </div>
              
              <!-- ESTUDIANTE -->
              <div class="row g-3 mb-3">
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-white d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                           style="width: 36px; height: 36px;">
                        <i class="bi bi-person text-muted fs-6"></i>
                      </div>
                      <div>
                        <strong class="fs-6 d-block">Carlos L칩pez</strong>
                        <small class="text-muted">Preparatoria - 2do a침o</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- CONTACTO -->
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex flex-column">
                      <small class="d-flex align-items-center mb-1">
                        <i class="bi bi-envelope me-2 text-primary"></i>carlos.lopez@email.com
                      </small>
                      <small class="d-flex align-items-center">
                        <i class="bi bi-star-fill me-2 text-warning"></i>4.5 
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ARCHIVOS -->
              <div class="pt-3 border-top">
                <h6 class="text-muted mb-3 small fw-semibold">Material</h6>
                <div class="d-flex flex-wrap gap-2">
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                    <small class="text-muted">Calculo_Intro.pdf</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <!-- SUBIR -->
                  <div class="border rounded-3 p-2 d-flex align-items-center justify-content-center upload-btn bg-light" 
                       style="width: 44px; height: 44px; cursor: pointer;" 
                       onclick="subirArchivo()">
                    <i class="bi bi-plus-lg text-muted"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ACCIONES -->
            <div class="col-12 col-lg-4 mt-4 mt-lg-0">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-chat me-2"></i>Mensaje
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script src="{% static 'js/tutoria.js' %}"></script>
{% endblock %}