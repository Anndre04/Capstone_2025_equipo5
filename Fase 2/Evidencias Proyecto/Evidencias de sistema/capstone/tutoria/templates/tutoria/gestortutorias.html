{% extends 'base.html' %}
{% load static %}
{% block title %}Gestor Tutor√≠as - Tutor√≠as Online{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4 px-lg-5 py-4">
  
  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h1 class="h2 mb-2 fw-bold text-dark">Gestor de Tutor√≠as</h1>
          <p class="text-muted mb-0">Administra tus tutor√≠as aceptadas</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SELECTORES -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <div class="row g-3 align-items-end">
            <!-- TUTORIA -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Anuncio</label>
              <select class="form-select border" id="selectAnuncio">
                <option value="">Selecciona Anuncio</option>
                {% for solicitud in solicitudes %}
                  {% if solicitud.anuncio %}
                    <option value="{{ solicitud.anuncio.id }}">
                      {{ solicitud.anuncio.titulo }}
                    </option>
                  {% endif %}
                {% empty %}
                  <option value="">No hay anuncios disponibles</option>
                {% endfor %}
              </select>
            </div>

            <!-- SOLICITUDES -->
            <div class="col-12 col-md-4">
              <label class="form-label fw-semibold">Solicitud</label>
              <!-- üîπ Inicialmente deshabilitado -->
              <select class="form-select border" id="selectSolicitud">
                <option value="">Selecciona Solicitud</option>
              </select>
            </div>

            <!-- BOT√ìN -->
            <div class="col-12 col-md-4">
              <button class="btn btn-primary w-100" id="btnIniciar">
                <i class="bi bi-camera-video me-2"></i>Iniciar Tutoria
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
      const selectAnuncio = document.getElementById("selectAnuncio");
      const selectSolicitud = document.getElementById("selectSolicitud");
      const btnIniciar = document.getElementById("btnIniciar");

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }
        
      // Inicialmente deshabilitado
      selectSolicitud.disabled = true;
      btnIniciar.disabled = true;

      selectAnuncio.addEventListener("change", async () => {
          const anuncioId = selectAnuncio.value;
          if (!anuncioId) {
              selectSolicitud.disabled = true;
              selectSolicitud.innerHTML = `<option value="">Selecciona Solicitud</option>`;
              return;
          }

          try {
              const response = await fetch(`/tutoria/obtener-alumnos/${anuncioId}/`);
              const data = await response.json();

              if (data.alumnos && data.alumnos.length > 0) {
                  selectSolicitud.disabled = false;
                  selectSolicitud.innerHTML = `
                      <option value="">Selecciona Solicitud</option>
                      ${data.alumnos.map(a => `<option value="${a.id}">${a.nombre} ${a.p_apellido} ${a.s_apellido}</option>`).join("")}
                  `;
              } else {
                  selectSolicitud.disabled = true;
                  selectSolicitud.innerHTML = `<option value="">No hay solicitudes aprobadas</option>`;
              }
          } catch (err) {
              console.error("Error cargando solicitudes:", err);
              selectSolicitud.disabled = true;
              selectSolicitud.innerHTML = `<option value="">Error al cargar</option>`;
          }
      });
      function actualizarBoton() {
          // Habilitar solo si hay anuncio y solicitud seleccionados
          
          btnIniciar.disabled = !(selectAnuncio.value && selectSolicitud.value);
      }

      selectAnuncio.addEventListener("change", actualizarBoton);
      selectSolicitud.addEventListener("change", actualizarBoton);

      btnIniciar.addEventListener("click", async () => {
        const anuncioId = selectAnuncio.value;
        const alumnoId = selectSolicitud.value;

        if (!anuncioId || !alumnoId) {
            alert("Selecciona un anuncio y un alumno");
            return;
        }

        try {
            const response = await fetch("/tutoria/crear-solicitud-tutoria/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({
                    anuncio_id: anuncioId,
                    alumno_id: alumnoId
                })
            });

            const data = await response.json();

            if (data.success) {
                alert("‚úÖ Solicitud de tutoria enviada correctamente");
                // Opcional: deshabilitar bot√≥n hasta que se refresque o cambiar estado
                btnIniciar.disabled = true;
            } else {
                alert("‚ùå Error: " + (data.error || "No se pudo crear la solicitud"));
            }
        } catch (err) {
            console.error("Error enviando solicitud:", err);
            alert("‚ùå Error al enviar la solicitud");
        }
    });
  });
</script>


  <!-- TUTOR√çAS -->
  <div class="row g-4">
    
    <!-- TUTOR√çA -->
    <div class="col-12">
      <div class="card border-0 shadow-sm hover-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <!-- INFO -->
            <div class="col-12 col-lg-8">
              <div class="d-flex align-items-start mb-3">
                <div class="flex-shrink-0">
                  <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                       style="width: 48px; height: 48px;">
                    <i class="bi bi-calculator text-primary fs-6"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h5 class="card-title mb-2 fw-bold text-dark">Matem√°ticas Avanzadas</h5>
                  <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary border-0">Ana Garc√≠a</span>
                    <span class="badge bg-light text-muted border">8/12 sesiones</span>
                  </div>
                </div>
              </div>
              
              <!-- ESTUDIANTE -->
              <div class="row g-3 mb-3">
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-white d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                           style="width: 36px; height: 36px;">
                        <i class="bi bi-person text-muted fs-6"></i>
                      </div>
                      <div>
                        <strong class="fs-6 d-block">Ana Garc√≠a</strong>
                        <small class="text-muted">Ing. Sistemas - 3er semestre</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- CONTACTO -->
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex flex-column">
                      <small class="d-flex align-items-center mb-1">
                        <i class="bi bi-envelope me-2 text-primary"></i>ana.garcia@email.com
                      </small>
                      <small class="d-flex align-items-center">
                        <i class="bi bi-star-fill me-2 text-warning"></i>4.5 
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ARCHIVOS -->
              <div class="pt-3 border-top">
                <h6 class="text-muted mb-3 small fw-semibold">Material</h6>
                <div class="d-flex flex-wrap gap-2">
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                    <small class="text-muted">Gu√≠a_Algebra.pdf</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-text text-primary me-2"></i>
                    <small class="text-muted">Ejercicios.docx</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <!-- SUBIR -->
                  <div class="border rounded-3 p-2 d-flex align-items-center justify-content-center upload-btn bg-light" 
                       style="width: 44px; height: 44px; cursor: pointer;" 
                       onclick="subirArchivo()">
                    <i class="bi bi-plus-lg text-muted"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ACCIONES -->
            <div class="col-12 col-lg-4 mt-4 mt-lg-0">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-chat me-2"></i>Mensaje
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TUTOR√çA -->
    <div class="col-12">
      <div class="card border-0 shadow-sm hover-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <!-- INFO -->
            <div class="col-12 col-lg-8">
              <div class="d-flex align-items-start mb-3">
                <div class="flex-shrink-0">
                  <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                       style="width: 48px; height: 48px;">
                    <i class="bi bi-graph-up text-info fs-6"></i>
                  </div>
                </div>
                <div class="flex-grow-1">
                  <h5 class="card-title mb-2 fw-bold text-dark">C√°lculo Diferencial</h5>
                  <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary border-0">Carlos L√≥pez</span>
                    <span class="badge bg-light text-muted border">5/10 sesiones</span>
                  </div>
                </div>
              </div>
              
              <!-- ESTUDIANTE -->
              <div class="row g-3 mb-3">
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-white d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                           style="width: 36px; height: 36px;">
                        <i class="bi bi-person text-muted fs-6"></i>
                      </div>
                      <div>
                        <strong class="fs-6 d-block">Carlos L√≥pez</strong>
                        <small class="text-muted">Preparatoria - 2do a√±o</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- CONTACTO -->
                <div class="col-12 col-sm-6">
                  <div class="bg-light rounded p-3">
                    <div class="d-flex flex-column">
                      <small class="d-flex align-items-center mb-1">
                        <i class="bi bi-envelope me-2 text-primary"></i>carlos.lopez@email.com
                      </small>
                      <small class="d-flex align-items-center">
                        <i class="bi bi-star-fill me-2 text-warning"></i>4.5 
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ARCHIVOS -->
              <div class="pt-3 border-top">
                <h6 class="text-muted mb-3 small fw-semibold">Material</h6>
                <div class="d-flex flex-wrap gap-2">
                  <div class="border rounded-3 p-2 d-flex align-items-center bg-white">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                    <small class="text-muted">Calculo_Intro.pdf</small>
                    <button class="btn btn-sm btn-light ms-2 p-1">
                      <i class="bi bi-download text-muted"></i>
                    </button>
                  </div>
                  <!-- SUBIR -->
                  <div class="border rounded-3 p-2 d-flex align-items-center justify-content-center upload-btn bg-light" 
                       style="width: 44px; height: 44px; cursor: pointer;" 
                       onclick="subirArchivo()">
                    <i class="bi bi-plus-lg text-muted"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ACCIONES -->
            <div class="col-12 col-lg-4 mt-4 mt-lg-0">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-chat me-2"></i>Mensaje
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.hover-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.08);
}

.hover-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
}

.card {
    border-radius: 16px;
}

.badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.35em 0.65em;
}

.btn {
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.form-select {
    border-radius: 10px;
    padding: 0.75rem 1rem;
    border: 1px solid #e9ecef;
}

.upload-btn {
    transition: all 0.2s ease;
    border: 1.5px dashed #dee2e6 !important;
}

.upload-btn:hover {
    background-color: #e9ecef !important;
    border-color: #0d6efd !important;
    transform: scale(1.05);
}

.upload-btn:hover .bi-plus-lg {
    color: #0d6efd !important;
}

@media (max-width: 768px) {
    .card-body {
        padding: 1.25rem !important;
    }
    
    .btn {
        font-size: 0.875rem;
    }
}

@media (max-width: 576px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .card-body {
        padding: 1rem !important;
    }
}

.card {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bg-light {
    background-color: #f8f9fa !important;
}
</style>
<script>

function subirArchivo() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.pdf,.doc,.docx,.txt';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const fileName = this.files[0].name;
            alert(`Archivo seleccionado: ${fileName}\n\n(Esta es una maqueta - En producci√≥n se subir√≠a el archivo)`);
        }
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}
</script>
{% endblock %}