{% extends 'base.html' %}
{% load static %}
{% block title %}Gestor Tutor铆as - Tutor铆as Online{% endblock %}

{% block content %}
  <link href="{% static "css/css_tutoria/gestortutoria.css" %}" rel="stylesheet">

    <div class="container-fluid px-3 px-md-4 px-lg-5 py-4">
    
    <!-- SELECTORES -->
    <div class="row mb-4">
        <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div>
            <h3 class="mb-2 fw-bold text-dark">Iniciar tutoria</h3>
            </div>
        </div>
        </div>
        <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <!-- TUTORIA -->
                <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Anuncio</label>
                <select class="form-select border" id="selectAnuncio">
                    <option value="">Selecciona Anuncio</option>
                    {% for anuncio in anuncios %}
                        <option value="{{ anuncio.id }}">
                            {{ anuncio.titulo }}
                        </option>
                    {% empty %}
                        <option value="">No hay anuncios disponibles</option>
                    {% endfor %}
                </select>
                </div>

                <!-- SOLICITUDES -->
                <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Solicitud</label>
                <!--  Inicialmente deshabilitado -->
                <select class="form-select border" id="selectSolicitud">
                    <option value="">Selecciona Solicitud</option>
                </select>
                </div>

                <!-- BOTN -->
                <div class="col-12 col-md-4">
                <button class="btn btn-primary w-100" id="btnIniciar">
                    <i class="bi bi-camera-video me-2"></i>Iniciar Tutoria
                </button>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>

    <div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-dark mb-1">Gesti贸n de Tutor铆as</h2>
                    <p class="text-muted mb-0">Administra y revisa todas tus sesiones de tutor铆a</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6">
                        {{ tutorias|length }} tutor铆a{{ tutorias|length|pluralize }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-4">
                        <i class="bi bi-funnel me-2"></i>Filtrar Tutor铆as
                    </h5>
                    
                    <form method="get" class="row g-4">
                        <!-- Filtro por Estudiante -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-dark">Estudiante</label>
                            <select name="estudiantes" class="form-select shadow-sm">
                                <option value="">Todos los estudiantes</option>
                                {% for info in alumnos_info %}
                                    <option value="{{ info.alumno.id }}" 
                                        {% if request.GET.estudiantes == info.alumno.id|stringformat:"s" %}selected{% endif %}>
                                        {{ info.alumno.nombre }} {{ info.alumno.p_apellido }} {{ info.alumno.s_apellido }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Filtro por Anuncio -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-dark">Materia/Anuncio</label>
                            <select name="anuncio" class="form-select shadow-sm">
                                <option value="">Todas las materias</option>
                                {% for anuncio in anuncios_unicos %}
                                    <option value="{{ anuncio.anuncio.id }}" {% if request.GET.anuncio == anuncio.anuncio.id|stringformat:"s" %}selected{% endif %}>
                                        {{ anuncio.anuncio.titulo }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-dark">Fecha</label>
                            <div class="input-group shadow-sm">
                                <input id="datetimepicker-fechagestortutoria" name="fecha" class="form-control" placeholder="Seleccione una fecha"
                                       value="{{ request.GET.fecha }}">
                                <span class="input-group-text">
                                    <i class="bi bi-calendar-event"></i>
                                </span>
                            </div>
                        </div>

                        <!-- Botones de Acci贸n -->
                        <div class="col-12">
                            <div class="d-flex gap-3 justify-content-end pt-3 border-top">
                                <a href="{% url 'tutoria:gestortutorias' %}" class="btn btn-outline-secondary px-4">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar
                                </a>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-search me-2"></i>Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Tutor铆as -->
    <div class="row">
        <div class="col-12">
            {% for tutoria in tutorias %}
            <div class="card border-0 shadow-sm mb-4 hover-lift">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <!-- Informaci贸n Principal -->
                        <div class="col-lg-8">
                            <div class="d-flex align-items-start">
                                <!-- Avatar del Estudiante -->
                                <div class="avatar-student me-4">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold fs-5"
                                         style="width: 60px; height: 60px;">
                                        {{ tutoria.estudiante.nombre|slice:":1" }}{{ tutoria.estudiante.p_apellido|slice:":1" }}
                                    </div>
                                </div>

                                <!-- Detalles de la Tutor铆a -->
                                <div class="flex-grow-1">
                                    <!-- Header -->
                                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-3">
                                        <h4 class="fw-bold text-dark mb-2 mb-md-0 me-3">{{ tutoria.anuncio.titulo }}</h4>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <span class="badge bg-primary bg-opacity-10 text-primary border-0 py-2">
                                                <i class="bi bi-person me-1"></i>{{ tutoria.estudiante.nombre_completo }}
                                            </span>
                                            <span class="badge bg-primary text-light py-2">
                                                {{ tutoria.anuncio.area }}
                                            </span>
                                            <span class="badge {% if tutoria.estado == 'Completada' %}bg-success{% elif tutoria.estado == 'Cancelada' %}bg-danger{% else %}bg-warning text-dark{% endif %} py-2">
                                                {{ tutoria.estado|title }}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Informaci贸n de Tiempo -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-muted">
                                                <i class="bi bi-clock me-2"></i>
                                                <div>
                                                    <small class="fw-semibold">Inicio</small>
                                                    <div class="text-dark fw-bold">{{ tutoria.hora_inicio|date:"d/m/Y H:i" }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="d-flex align-items-center text-muted">
                                                <i class="bi bi-clock-fill me-2"></i>
                                                <div>
                                                    <small class="fw-semibold">Fin</small>
                                                    <div class="text-dark fw-bold">{{ tutoria.hora_fin|date:"d/m/Y H:i" }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones -->
                        <div class="col-lg-4 mt-4 mt-lg-0">
                            <div class="d-flex flex-column gap-3">
                                <a href="#" class="btn btn-primary btn-lg py-2 fw-semibold">
                                    <i class="bi bi-chat-dots me-2"></i>Enviar Mensaje
                                </a>
                                <a href="{% url "tutoria:detalle_tutoria" tutoria.id %}" class="btn btn-outline-dark btn-lg py-2 fw-semibold">
                                    <i class="bi bi-eye me-2"></i>Ver Detalles
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <!-- Estado Vac铆o -->
            <div class="text-center py-5">
                <div class="empty-state-icon mb-4">
                    <i class="bi bi-calendar-x display-1 text-muted opacity-25"></i>
                </div>
                <h3 class="text-muted mb-3">No hay tutor铆as registradas</h3>
                <p class="text-muted mb-4">
                    {% if request.GET %}
                        No se encontraron resultados para los filtros aplicados.
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>



<style>
    
</style>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Inicializaci贸n de selectores y bot贸n
        const selectAnuncio = document.getElementById("selectAnuncio");
        const selectSolicitud = document.getElementById("selectSolicitud");
        const btnIniciar = document.getElementById("btnIniciar");

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Inicialmente deshabilitado
        selectSolicitud.disabled = true;
        btnIniciar.disabled = true;

        selectAnuncio.addEventListener("change", async () => {
            const anuncioId = selectAnuncio.value;
            if (!anuncioId) {
                selectSolicitud.disabled = true;
                selectSolicitud.innerHTML = `<option value="">Selecciona Solicitud</option>`;
                btnIniciar.disabled = true; // Asegurarse que el bot贸n se deshabilite
                return;
            }

            try {
                const response = await fetch(`/tutoria/obtener-alumnos/${anuncioId}/`);
                const data = await response.json();

                // Limpiar y poblar el selector de solicitudes
                selectSolicitud.innerHTML = `<option value="">Selecciona Solicitud</option>`;

                if (data.alumnos && data.alumnos.length > 0) {
                    selectSolicitud.disabled = false;
                    selectSolicitud.innerHTML += `
                        ${data.alumnos.map(a => `<option value="${a.id}">${a.nombre} ${a.p_apellido} ${a.s_apellido}</option>`).join("")}
                    `;
                } else {
                    selectSolicitud.disabled = true;
                    selectSolicitud.innerHTML = `<option value="">No hay solicitudes aprobadas</option>`;
                }
            } catch (err) {
                console.error("Error cargando solicitudes:", err);
                selectSolicitud.disabled = true;
                selectSolicitud.innerHTML = `<option value="">Error al cargar</option>`;
            }
            actualizarBoton();
        });

        function actualizarBoton() {
            btnIniciar.disabled = !(selectAnuncio.value && selectSolicitud.value);
        }

        selectAnuncio.addEventListener("change", actualizarBoton);
        selectSolicitud.addEventListener("change", actualizarBoton);

        //  Enviar solicitud
        btnIniciar.addEventListener("click", async () => {
            const anuncioId = selectAnuncio.value;
            const alumnoId = selectSolicitud.value;

            if (!anuncioId || !alumnoId) {
                Swal.fire({
                    icon: "warning",
                    title: "Faltan datos",
                    text: "Selecciona un anuncio y un alumno antes de continuar"
                });
                return;
            }

            try {
                const response = await fetch("/tutoria/crear-solicitud-tutoria/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({
                        anuncio_id: anuncioId,
                        alumno_id: alumnoId
                    })
                });

                const data = await response.json();
                let modalEspera; // Variable para almacenar la instancia del modal

                if (data.tipo === "success") {
                    // 1. Mostrar modal de espera usando BS5Helper.Modal.wait
                    modalEspera = BS5Helper.Modal.wait({ 
                        titulo: "Solicitud enviada",
                        mensaje: "Esperando que el alumno responda...",
                        tipo: "info",
                        id: "modal-polling-espera"
                    });
                    
                    // 2. L贸gica de Polling (similar a tu implementaci贸n original)
                    const interval = setInterval(async () => {
                        try {
                            const res = await fetch(`/tutoria/estado-solicitud/${data.solicitud_id}/`);
                            const estadoData = await res.json();

                            if (estadoData.estado === "Aceptada") {
                                clearInterval(interval);
                                BS5Helper.Modal.close("modal-polling-espera"); // Cerrar modal antes de redirecci贸n
                                
                                // Mostrar Toast de 茅xito (opcional, si quieres confirmaci贸n visual)
                                BS5Helper.Modal.modalIcono({
                                    titulo: "Solicitud aceptada",
                                    mensaje: "El alumno ha aceptado la solicitud. Redirigiendo...",
                                    tipo: "success",
                                    duracion: 2000,
                                    redirigiendo: 1
                                }).then(() => {
                                    window.location.href = `/tutoria/tutoria/${estadoData.tutoria_id}`;
                                });
                            } else if (estadoData.estado === "Rechazada") {
                                clearInterval(interval);
                                BS5Helper.Modal.close("modal-polling-espera"); // Cerrar el modal de espera
                                
                                // 3. Mostrar notificaci贸n de rechazo usando BS5Helper.Toast
                                BS5Helper.Modal.modalIcono({
                                    titulo: "Solicitud rechazada",
                                    mensaje: "El alumno ha rechazado la solicitud.",
                                    tipo: "danger"
                                });
                            }
                        } catch (e) {
                            console.error("Error consultando estado:", e);
                            // Si falla el polling, cerrar el modal para no bloquear al usuario
                            clearInterval(interval);
                            BS5Helper.Modal.close("modal-polling-espera");
                            BS5Helper.Toast.mostrar({
                                mensaje: "Error de conexi贸n al verificar el estado.",
                                tipo: "danger"
                            });
                        }
                    }, 1000); // Polling cada 1 segundo

                } else {
                    // 4. Mostrar error de l贸gica de negocio (e.g., ya solicitada)
                    BS5Helper.Toast.mostrar({
                        mensaje: data.error || "No se pudo crear la solicitud",
                        tipo: "danger"
                    });
                }
            } catch (err) {
                console.error("Error enviando solicitud:", err);
                // 5. Mostrar error de red/fetch
                BS5Helper.Toast.mostrar({
                    mensaje: "Error de red: No se pudo enviar la solicitud.",
                    tipo: "danger"
                });
            }
        });
    });
</script>

<script src="{% static 'js/js_tutoria/tutoria.js' %}"></script>
{% endblock %}