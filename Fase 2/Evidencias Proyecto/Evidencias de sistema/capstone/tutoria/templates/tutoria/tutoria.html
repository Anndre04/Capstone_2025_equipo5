{% extends "base.html" %}

{% block title %}Tutoría{% endblock %}

{% block content %}

{% if tutoria and tutoria.estado == "En curso" %}
<div class="container-fluid">

<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <div>
        <h1 class="h2 mb-2 fw-bold text-dark">Tutoría: {{ tutoria.anuncio.titulo }}</h1>
        <p class="text-muted mb-0">
          Tutor: {{ tutoria.tutor.usuario.nombre }} {{ tutoria.tutor.usuario.p_apellido }}
        </p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const tutoriaId = "{{ tutoria.id }}";
    const horaFin = new Date("{{ tutoria.hora_fin|date:'c' }}");
    let tutoriaCompletada = false;

    // Revisa periódicamente si ya terminó la tutoría
    function checkTutoria() {
        const ahora = new Date();
        if (!tutoriaCompletada && ahora >= horaFin) {
            tutoriaCompletada = true;
            clearInterval(intervalo);
            completarTutoria();
        }
    }

    // Solo marca la tutoría como completada (sin mostrar Swal)
    async function completarTutoria() {
        try {
            const response = await fetch(`/tutoria/tutoria-completada/${tutoriaId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) throw new Error("Error al completar la tutoría");

            // El modal o la reseña se manejarán desde notificacion.js
            console.log("✅ Tutoría completada correctamente");
        } catch (err) {
            console.error("❌ Error completando tutoría:", err);
        }
    }

    const intervalo = setInterval(checkTutoria, 5000);
    checkTutoria();
});
</script>


</div>
    {% else %}
    NOOOOOOOOOOOOO

{% endif %}
{% endblock %}