{% extends "base.html" %}

{% block title %}Tutoría{% endblock %}

{% block content %}

{% if tutoria and tutoria.estado == "En curso" %}
<div class="container-fluid">

<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <div>
        <h1 class="h2 mb-2 fw-bold text-dark">Tutoría: {{ tutoria.anuncio.titulo }}</h1>
        <p class="text-muted mb-0">
          Tutor: {{ tutoria.tutor.usuario.nombre }} {{ tutoria.tutor.usuario.p_apellido }}
        </p>
      </div>
    </div>
  </div>
</div>



  <!-- VIDEOCALL & CHAT SECTION -->
<div class="row g-4" id="videocallSection">
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Videollamada</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-light" id="btnToggleMic">
            <i class="bi bi-mic-fill"></i>
          </button>
          <button class="btn btn-sm btn-light" id="btnToggleCam">
            <i class="bi bi-camera-video-fill"></i>
          </button>
          <button class="btn btn-sm btn-danger" id="btnEndCall">
            <i class="bi bi-telephone-fill"></i>
          </button>
        </div>
      </div>
      <div class="card-body p-0 position-relative">
        <!-- Video local -->
        <div class="position-absolute top-0 end-0 m-3 z-1" style="width: 200px; height: 150px;">
          <video id="localVideo" autoplay muted class="w-100 h-100 rounded shadow-sm bg-dark"></video>
          <div class="position-absolute bottom-0 start-0 bg-dark bg-opacity-75 text-white px-2 py-1 small rounded-top-end">
            Tú
          </div>
        </div>

        <!-- Video remoto -->
        <div class="w-100 h-100 min-vh-50 bg-dark bg-opacity-10 d-flex align-items-center justify-content-center">
          <video id="remoteVideo" autoplay class="w-100 h-100" style="max-height: 500px;"></video>
          <div id="waitingMessage" class="text-center text-muted p-4">
            <i class="bi bi-camera-video-off display-4 d-block mb-3"></i>
            <h5>Esperando conexión...</h5>
            <p>La videollamada se iniciará cuando el alumno se una</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">Chat</h5>
      </div>
      <div class="card-body p-0 d-flex flex-column">
        <!-- Mensajes del chat -->
        <div id="chatMessages" class="flex-grow-1 p-3" style="height: 300px; overflow-y: auto;">
          <div class="text-center text-muted py-4">
            <i class="bi bi-chat-dots display-6 d-block mb-2"></i>
            <p>El chat está listo para usar</p>
          </div>
        </div>

        <!-- Input para enviar mensajes -->
        <div class="border-top p-3">
          <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Escribe un mensaje..." disabled>
            <button class="btn btn-primary" id="btnSendMessage" disabled>
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const videocallSection = document.getElementById("videocallSection");
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const waitingMessage = document.getElementById("waitingMessage");
  const btnToggleMic = document.getElementById("btnToggleMic");
  const btnToggleCam = document.getElementById("btnToggleCam");
  const btnEndCall = document.getElementById("btnEndCall");
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const btnSendMessage = document.getElementById("btnSendMessage");

  let localStream = null;
  let isMicOn = true;
  let isCamOn = true;
  let isCallActive = false;

  async function iniciarVideollamada() {
    try {
      videocallSection.classList.remove("d-none");
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      chatInput.disabled = false;
      btnSendMessage.disabled = false;
      isCallActive = true;

      setTimeout(() => {
        waitingMessage.classList.add("d-none");
        remoteVideo.classList.remove("d-none");
      }, 3000);

    } catch (error) {
      console.error("Error accediendo a los dispositivos:", error);
      alert("No se pudo acceder a la cámara o micrófono");
    }
  }

  btnToggleMic.addEventListener("click", () => {
    if (localStream) {
      localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
      isMicOn = !isMicOn;
      btnToggleMic.innerHTML = isMicOn ? '<i class="bi bi-mic-fill"></i>' : '<i class="bi bi-mic-mute-fill"></i>';
    }
  });

  btnToggleCam.addEventListener("click", () => {
    if (localStream) {
      localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
      isCamOn = !isCamOn;
      btnToggleCam.innerHTML = isCamOn ? '<i class="bi bi-camera-video-fill"></i>' : '<i class="bi bi-camera-video-off-fill"></i>';
    }
  });

  btnEndCall.addEventListener("click", () => {
    if (localStream) localStream.getTracks().forEach(track => track.stop());
    isCallActive = false;
    videocallSection.classList.add("d-none");
    chatInput.disabled = true;
    btnSendMessage.disabled = true;
  });

  btnSendMessage.addEventListener("click", enviarMensaje);
  chatInput.addEventListener("keypress", (e) => { if(e.key === "Enter") enviarMensaje(); });

  function enviarMensaje() {
    const mensaje = chatInput.value.trim();
    if (!mensaje || !isCallActive) return;
    agregarMensaje("Tú", mensaje, true);
    chatInput.value = "";
    // Simular respuesta
    setTimeout(() => {
      const respuestas = [
        "Entendido, gracias.",
        "¿Podrías repetir eso?",
        "Perfecto, ahora lo entiendo."
      ];
      const respuestaAleatoria = respuestas[Math.floor(Math.random() * respuestas.length)];
      agregarMensaje("Alumno", respuestaAleatoria, false);
    }, 1000 + Math.random() * 2000);
  }

  function agregarMensaje(autor, mensaje, esPropio) {
    const mensajeDiv = document.createElement("div");
    mensajeDiv.className = `d-flex mb-3 ${esPropio ? 'justify-content-end' : 'justify-content-start'}`;
    const contenidoDiv = document.createElement("div");
    contenidoDiv.className = `rounded p-3 ${esPropio ? 'bg-primary text-white' : 'bg-light'}`;
    contenidoDiv.style.maxWidth = "70%";
    const autorSpan = document.createElement("div");
    autorSpan.className = "small fw-bold";
    autorSpan.textContent = autor;
    const textoDiv = document.createElement("div");
    textoDiv.textContent = mensaje;
    contenidoDiv.appendChild(autorSpan);
    contenidoDiv.appendChild(textoDiv);
    mensajeDiv.appendChild(contenidoDiv);
    chatMessages.appendChild(mensajeDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Para probar, iniciar la videollamada automáticamente (opcional)
  // iniciarVideollamada();
});
</script>

</div>
    {% else %}
    NOOOOOOOOOOOOO

{% endif %}
{% endblock %}