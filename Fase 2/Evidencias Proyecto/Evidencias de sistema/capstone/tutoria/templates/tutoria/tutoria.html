{% extends "base.html" %}

{% block title %}Tutoría{% endblock %}

{% block content %}

{% if tutoria and tutoria.estado == "En curso" %}
<div class="container-fluid px-0">
    <!-- Header de estado mejorado -->
    <div class="bg-light border-bottom py-2 px-3">
        <div class="d-flex justify-content-between align-items-center">
            <p id="status" class="mb-0 fw-semibold text-warning d-flex align-items-center">
                <i class="bi bi-circle-fill me-2 fs-6"></i>Iniciando...
            </p>
            <div class="text-muted small">
                <i class="bi bi-clock me-1"></i>
                <span id="callTimer">00:00</span>
            </div>
        </div>
    </div>

    <div class="row g-0 g-lg-3" id="videocallSection">
        <!-- Sección de video principal - Mejorada visualmente -->
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm h-100 video-card">
                <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center py-2">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-camera-video me-2"></i>Videollamada
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2" id="participantCount">1 participante</span>
                        <span class="badge bg-success" id="connectionStatus">Conectado</span>
                    </div>
                </div>
                
                <div class="card-body p-0 position-relative video-body-container bg-dark">
                    <!-- Video remoto principal -->
                    <div id="remoteVideoWrapper" class="w-100 h-100 d-flex align-items-center justify-content-center main-video-wrapper">
                        <video id="remoteVideo" autoplay playsinline class="w-100 h-100 main-video" style="object-fit: contain;"></video>

                        <!-- Controles de video mejorados -->
                        <div id="videoControls" class="position-absolute bottom-0 start-50 translate-middle-x p-3 mb-3 rounded-3 shadow-lg bg-dark bg-opacity-85 d-flex gap-2 flex-wrap justify-content-center">
                            <button class="btn btn-control rounded-circle" id="btnToggleMic" title="Silenciar">
                                <i class="bi bi-mic-fill"></i>
                            </button>
                            <button class="btn btn-control rounded-circle" id="btnToggleCam" title="Cámara On/Off">
                                <i class="bi bi-camera-video-fill"></i>
                            </button>
                            <button class="btn btn-control rounded-pill px-3" id="btnShareScreen" title="Compartir Pantalla">
                                <i class="bi bi-display-fill me-1"></i> Compartir
                            </button>
                            <button class="btn btn-control rounded-pill px-3" id="btnRecord" title="Iniciar Grabación">
                                <i class="bi bi-record-circle-fill me-1"></i> Grabar
                            </button>
                            <button class="btn btn-danger rounded-circle" id="btnEndCall" title="Finalizar llamada">
                                <i class="bi bi-telephone-fill"></i>
                            </button>
                            <button class="btn btn-control rounded-circle" id="btnToggleFullscreen" title="Pantalla Completa">
                                <i class="bi bi-arrows-fullscreen"></i>
                            </button>
                        </div>
                        
                        <!-- Mensaje de espera mejorado -->
                        <div id="waitingMessage" class="position-absolute top-50 start-50 translate-middle text-center text-light p-4">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Conectando...</span>
                            </div>
                            <h5 class="mb-2">Esperando conexión</h5>
                            <p class="text-light opacity-75 mb-0">La videollamada se iniciará cuando el otro usuario se una</p>
                        </div>
                    </div>

                    <!-- Video local mejorado -->
                    <div id="localVideoContainer" class="position-absolute top-0 end-0 m-3 z-1 shadow border border-2 border-primary rounded-3 overflow-hidden" style="width: 180px; height: 120px; background: #000;">
                        <video id="localVideo" autoplay muted playsinline class="w-100 h-100" style="object-fit: cover;"></video>
                        <div class="position-absolute bottom-0 start-0 bg-dark bg-opacity-75 text-white px-2 py-1 small rounded-top-end d-flex align-items-center">
                            <i class="bi bi-person-fill me-1"></i>Tú
                        </div>
                        <!-- Indicador de estado de micrófono/cámara -->
                        <div class="position-absolute top-0 start-0 p-1">
                            <i class="bi bi-mic-fill text-success" id="localMicIndicator"></i>
                            <i class="bi bi-camera-video-fill text-success ms-1" id="localCamIndicator"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de acción mejorados -->
            <div id="tutoriaActions" class="d-flex flex-column flex-sm-row gap-2 mt-3 px-2" style="display: none;">
                <button 
                    id="btnSubirDocumento"
                    type="button"
                    class="btn btn-success shadow-sm d-flex align-items-center justify-content-center flex-grow-1"
                    data-bs-toggle="modal"
                    data-bs-target="#uploadDocumentModal"
                    style="display:none">
                    <i class="bi bi-file-earmark-arrow-up-fill me-2"></i> Subir Documento
                </button>
                <button 
                    id="btnRealizarEvaluacion"
                    type="button"
                    class="btn btn-primary shadow-sm d-flex align-items-center justify-content-center flex-grow-1"
                    data-bs-toggle="modal"
                    data-bs-target="#crearEvaluacionModal"
                    style="display:none">
                    <i class="bi bi-clipboard-check-fill me-2"></i> Realizar Evaluación
                </button>
            </div>
        </div>

        <!-- Chat mejorado -->
        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm h-100 chat-card">
                <div class="card-header bg-secondary bg-gradient text-white py-2">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-chat-dots me-2"></i>Chat
                        <span class="badge bg-light text-dark ms-2 small" id="messageCount">0</span>
                    </h5>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <div id="chatMessages" class="flex-grow-1 p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-square-text display-6 d-block mb-3 opacity-50"></i>
                            <p class="mb-0">El chat está listo para usar</p>
                            <small class="text-muted">Envía un mensaje para comenzar</small>
                        </div>
                    </div>

                    <div class="border-top p-3 bg-white">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control rounded-start" placeholder="Escribe un mensaje..." disabled>
                            <button class="btn btn-primary rounded-end d-flex align-items-center" id="btnSendMessage" disabled>
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                        <div class="form-text text-end mt-1">
                            <small>Presiona Enter para enviar</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales (mantenidos con mejoras visuales menores) -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-3">
            <div class="modal-header bg-success bg-gradient text-white rounded-top-3">
                <h5 class="modal-title d-flex align-items-center" id="uploadDocumentModalLabel">
                    <i class="bi bi-cloud-upload-fill me-2"></i>Subir documentos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <form method="POST" action="{% url "tutoria:archivostutoria" tutoria.id %}" enctype="multipart/form-data" id="uploadForm"> 
                    {% csrf_token %} 
                    
                    <input type="hidden" name="tutoria_id" id="tutoriaIdInput" value=""> 

                    <div class="mb-4 border p-3 rounded-3 bg-light">
                        <label for="id_archivo" class="form-label fw-semibold d-flex align-items-center">
                            <i class="bi bi-file-pdf me-2 text-danger"></i>Seleccionar Archivos (PDF)
                        </label>
                        <input 
                            type="file" 
                            name="archivo" 
                            id="id_archivo" 
                            class="form-control"
                            accept="application/pdf"
                            multiple 
                        >
                        <div class="form-text text-muted mt-1">Puedes seleccionar múltiples archivos PDF</div>
                    </div>
                        
                    <div id="archivos-seleccionados-container" class="mt-3">
                        <p class="fw-semibold small mb-2 d-flex align-items-center">
                            <i class="bi bi-list-check me-2"></i>Archivos seleccionados:
                        </p>
                        <div id="lista-archivos-seleccionados" class="border rounded-3 bg-white">
                            <div class="text-muted p-3 text-center" id="initial-message">
                                <i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>
                                Ningún archivo seleccionado
                            </div>
                        </div>
                        <div id="file-error-message" class="text-danger small mt-2 d-none"></div>
                    </div>

                    <div class="modal-footer border-0 pt-4">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success d-flex align-items-center" id="confirmUploadBtn">
                            <i class="bi bi-cloud-check me-2"></i>Confirmar Subida
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Evaluación -->
<div class="modal fade" id="crearEvaluacionModal" tabindex="-1" aria-labelledby="crearEvaluacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">

      <form id="crearEvaluacionForm" action="{% url "crearevaluacion" tutoria.id %}" method="post">
        {% csrf_token %}
        <div class="modal-header bg-primary bg-gradient text-white">
          <h5 class="modal-title d-flex align-items-center" id="crearEvaluacionLabel">
            <i class="bi bi-clipboard-plus-fill me-2"></i>Crear Evaluación
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <!-- Título -->
          <div class="mb-3">
            <label for="titulo" class="form-label fw-semibold">Título de la Evaluación:</label>
            <input type="text" class="form-control" name="titulo" id="tituloEvaluacion" placeholder="Ingresa el título de la evaluación">
          </div>

          <!-- Contenedor de preguntas -->
          <div class="container-fluid px-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 fw-bold d-flex align-items-center">
                <i class="bi bi-question-circle-fill me-2 text-primary"></i>Preguntas
              </h5>
              <button id="btnAgregarPregunta" type="button" class="btn btn-outline-primary btn-sm d-flex align-items-center">
                <i class="bi bi-plus-circle me-1"></i> Agregar Pregunta
              </button>
            </div>
            <div id="preguntasContainer"></div>
            <small class="text-danger d-none mt-2 d-flex align-items-center" id="errorPreguntas">
                <i class="bi bi-exclamation-circle-fill me-1"></i>Debe agregar al menos una pregunta.
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" id="btnenviarEvaluacion" class="btn btn-success d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>Guardar Evaluación
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Estilos CSS mejorados -->
<style>
/* Variables de colores para consistencia */
:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --dark-color: #212529;
}

/* Estilos generales mejorados */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Mejoras para la sección de video */
.video-card, .chat-card {
    height: 100%;
    max-height: 75vh;
}

.video-body-container {
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.main-video-wrapper {
    height: 100%;
}

.main-video {
    object-fit: contain !important; 
}

/* Controles de video mejorados */
#videoControls {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-control {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    border: none;
    transition: all 0.2s ease;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-control:hover {
    background-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.btn-control.rounded-pill {
    width: auto;
    padding-left: 16px;
    padding-right: 16px;
}

/* Indicadores de estado */
#localMicIndicator, #localCamIndicator {
    font-size: 0.7rem;
}

/* Mejoras para el chat */
#chatMessages {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Mensajes del chat mejorados */
.chat-message {
    max-width: 80%;
    word-wrap: break-word;
}

.chat-message.local {
    margin-left: auto;
    background-color: var(--primary-color);
    color: white;
    border-radius: 18px 18px 4px 18px;
}

.chat-message.remote {
    margin-right: auto;
    background-color: white;
    color: var(--dark-color);
    border-radius: 18px 18px 18px 4px;
    border: 1px solid #e9ecef;
}

.chat-message.system {
    margin: 0 auto;
    background-color: transparent;
    color: #6c757d;
    font-style: italic;
}

/* Responsive mejorado */
@media (max-width: 991.98px) {
    .video-card, .chat-card {
        max-height: 50vh;
        margin-bottom: 1rem;
    }
    
    .chat-card {
        height: 40vh;
    }
    
    #localVideoContainer {
        width: 120px !important;
        height: 90px !important;
    }
    
    #videoControls {
        padding: 0.5rem !important;
        gap: 0.25rem !important;
        transform: translateX(-50%) scale(0.9);
    }
    
    .btn-control {
        width: 40px;
        height: 40px;
    }
    
    .btn-control.rounded-pill {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
    }
}

@media (max-width: 575.98px) {
    .video-card, .chat-card {
        max-height: 45vh;
    }
    
    #localVideoContainer {
        width: 100px !important;
        height: 75px !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
    }
    
    #videoControls {
        width: 95%;
        flex-wrap: wrap;
        gap: 0.5rem !important;
    }
    
    .btn-control {
        width: 36px;
        height: 36px;
        font-size: 0.8rem;
    }
}

/* Estilos de Fullscreen mejorados */
#remoteVideoWrapper:-webkit-full-screen {
    width: 100% !important;
    height: 100% !important;
    background: #000;
}

#remoteVideoWrapper:fullscreen {
    width: 100% !important;
    height: 100% !important;
    background: #000;
}

/* Animaciones suaves */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Mejoras para los botones de acción */
#tutoriaActions .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

#tutoriaActions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Badges mejorados */
.badge {
    font-size: 0.7rem;
    font-weight: 500;
}

/* Mejoras para modales */
.modal-content {
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 1rem 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

/* Mejoras para la lista de archivos */
#lista-archivos-seleccionados .file-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s;
}

#lista-archivos-seleccionados .file-item:hover {
    background-color: #f8f9fa;
}

#lista-archivos-seleccionados .file-item:last-child {
    border-bottom: none;
}
</style>

<!-- JavaScript para mejoras visuales (sin afectar funcionalidad) -->
<script>
// Timer para la llamada
let callStartTime = Date.now();
let callTimerInterval;

function updateCallTimer() {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('callTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Iniciar timer cuando la llamada se conecte
function startCallTimer() {
    callStartTime = Date.now();
    callTimerInterval = setInterval(updateCallTimer, 1000);
}

// Detener timer cuando finalice la llamada
function stopCallTimer() {
    if (callTimerInterval) {
        clearInterval(callTimerInterval);
    }
}

// Actualizar contador de mensajes
function updateMessageCount() {
    const messages = document.querySelectorAll('#chatMessages .chat-message:not(.system)');
    document.getElementById('messageCount').textContent = messages.length;
}

// Mejorar la función appendMessage para incluir contador
const originalAppendMessage = window.appendMessage;
window.appendMessage = function(message, sender) {
    if (originalAppendMessage) {
        originalAppendMessage(message, sender);
    } else {
        // Implementación de respaldo si la función original no existe
        const isSystem = sender.startsWith("system");
        const isRemote = sender === "remote";
        const className = isSystem ? "chat-message system text-center text-muted p-2" : 
                          (isRemote ? "chat-message remote p-3 mb-2" : "chat-message local p-3 mb-2");
        
        const messageHtml = `
            <div class="${className} fade-in">
                ${!isSystem ? `<small class="d-block mb-1 opacity-75">${isRemote ? 'Otro Usuario' : 'Tú'}</small>` : ''}
                <div class="message-content">${message}</div>
            </div>
        `;
        chatMessages.innerHTML += messageHtml;
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Actualizar contador de mensajes
    updateMessageCount();
};

// Mejorar indicadores de micrófono y cámara locales
function updateLocalIndicators() {
    const micIndicator = document.getElementById('localMicIndicator');
    const camIndicator = document.getElementById('localCamIndicator');
    
    if (micIndicator) {
        micIndicator.className = currentAudioEnabled ? 
            'bi bi-mic-fill text-success' : 'bi bi-mic-mute-fill text-danger';
    }
    
    if (camIndicator) {
        camIndicator.className = currentVideoEnabled ? 
            'bi bi-camera-video-fill text-success' : 'bi bi-camera-video-off-fill text-danger';
    }
}

// Sobrescribir funciones de toggle para actualizar indicadores
const originalToggleMic = window.toggleMic;
window.toggleMic = function() {
    if (originalToggleMic) originalToggleMic();
    updateLocalIndicators();
};

const originalToggleCam = window.toggleCam;
window.toggleCam = function() {
    if (originalToggleCam) originalToggleCam();
    updateLocalIndicators();
};

// Inicializar cuando el DOM esté listo
document.addEventListener("DOMContentLoaded", function() {

    
    // Actualizar indicadores iniciales
    updateLocalIndicators();
    
    // Mejorar la lista de archivos en el modal
    const fileCustomizer = new FileCustomizer('id_archivo', 'lista-archivos-seleccionados');
    
    // Añadir clase para elementos de archivo
    const originalRenderFileList = fileCustomizer.renderFileList;
    fileCustomizer.renderFileList = function() {
        originalRenderFileList.call(this);
        
        // Añadir clases CSS a los elementos de archivo
        const fileItems = this.listaArchivos.querySelectorAll('li');
        fileItems.forEach(item => {
            item.classList.add('file-item');
        });
    };
    
    // Forzar renderizado inicial
    fileCustomizer.renderFileList();
});


function onCallConnected() {
    startCallTimer();
    document.getElementById('connectionStatus').textContent = 'Conectado';
    document.getElementById('connectionStatus').className = 'badge bg-success';
}

function onCallDisconnected() {
    stopCallTimer();
    document.getElementById('connectionStatus').textContent = 'Desconectado';
    document.getElementById('connectionStatus').className = 'badge bg-danger';
}
</script>

<!-- El resto del JavaScript existente se mantiene igual -->
<script>

</script>

{% else %}
<div class="container mt-5">
    <div class="alert alert-danger shadow-sm" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <h4 class="alert-heading mb-1">Tutoría No Disponible</h4>
                <p class="mb-0">La tutoría con ID <strong>{{ tutoria.id }}</strong> no está marcada como "En curso" o no existe.</p>
            </div>
        </div>
        <hr>
        <p class="mb-0">Por favor, verifique el estado en su panel de control.</p>
    </div>
</div>
{% endif %}
{% endblock %}