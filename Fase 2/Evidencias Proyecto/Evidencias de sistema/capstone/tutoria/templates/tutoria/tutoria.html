{% extends "base.html" %}
{% load static %}

{% block title %}Tutoría{% endblock %}

{% block content %}

{% if tutoria and tutoria.estado == "En curso" %}

<div id="info" data-user="{{ request.user.id }}" data-tutoria-id="{{ tutoria.id }}" data-hora-inicio="{{ tutoria.hora_inicio|date:'c' }}"
     data-hora-fin="{{ tutoria.hora_fin|date:'c' }}"></div>

<div class="container-fluid">

    <div class="px-0">
        <!-- Header de estado mejorado -->
        <div class="bg-light border-bottom py-2 px-3">
            <div class="d-flex justify-content-between align-items-center">
                <p id="status" class="mb-0 fw-semibold text-warning d-flex align-items-center">
                    <i class="bi bi-circle-fill me-2 fs-6"></i>Iniciando...
                </p>
                <div class="text-muted small"></div>
            </div>
        </div>

        <div class="row g-0 g-lg-3" id="videocallSection">
            <!-- Sección de video principal -->
            <div class="col-12 col-lg-8">
                <div class="card border-0 shadow-sm h-100 video-card">
                    <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center py-2">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-camera-video me-2"></i>Videollamada
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2" id="connectionStatus">Conectado</span>
                            <i class="bi bi-clock me-2"></i>
                            <span id="callTimer" data-elapsed="{{ tiempo_transcurrido|default:0 }}">00:00</span>
                        </div>
                    </div>

                    <div class="card-body p-0 position-relative video-body-container bg-dark">
                        <div id="remoteVideoWrapper" class="w-100 h-100 d-flex align-items-center justify-content-center main-video-wrapper">
                            <video id="remoteVideo" autoplay playsinline class="w-100 h-100 main-video" style="object-fit: contain;"></video>

                            <div id="videoControls" class="position-absolute bottom-0 start-50 translate-middle-x p-3 mb-3 rounded-3 shadow-lg bg-dark bg-opacity-85 d-flex gap-2 flex-wrap justify-content-center">
                                <button class="btn btn-control rounded-circle" id="btnToggleMic" title="Silenciar">
                                    <i class="bi bi-mic-fill"></i>
                                </button>
                                <button class="btn btn-control rounded-circle" id="btnToggleCam" title="Cámara On/Off">
                                    <i class="bi bi-camera-video-fill"></i>
                                </button>
                                <button class="btn btn-control rounded-pill px-3" id="btnShareScreen" title="Compartir Pantalla">
                                    <i class="bi bi-display-fill me-1"></i> Compartir
                                </button>
                                <button class="btn btn-control rounded-circle" id="btnToggleFullscreen" title="Pantalla Completa">
                                    <i class="bi bi-arrows-fullscreen"></i>
                                </button>
                            </div>

                            <div id="waitingMessage" class="position-absolute top-50 start-50 translate-middle text-center text-light p-4">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Conectando...</span>
                                </div>
                                <h5 class="mb-2">Esperando conexión</h5>
                                <p class="text-light opacity-75 mb-0">La videollamada se iniciará cuando el otro usuario se una</p>
                            </div>
                        </div>

                        <div id="localVideoContainer" class="position-absolute top-0 end-0 m-3 z-1 shadow border border-2 border-primary rounded-3 overflow-hidden" style="width: 180px; height: 120px; background: #000;">
                            <video id="localVideo" autoplay muted playsinline class="w-100 h-100" style="object-fit: cover;"></video>
                            <div class="position-absolute bottom-0 start-0 bg-dark bg-opacity-75 text-white px-2 py-1 small rounded-top-end d-flex align-items-center">
                                <i class="bi bi-person-fill me-1"></i>Tú
                            </div>
                        </div>
                    </div>
                </div>

                <div id="botonestutor" class="d-flex flex-column flex-sm-row gap-2 mt-5 px-2 d-none">
                    <button 
                        id="btnSubirDocumento"
                        type="button"
                        class="btn btn-success shadow-sm d-flex align-items-center justify-content-center flex-grow-1 d-none"
                        data-bs-toggle="modal"
                        data-bs-target="#uploadDocumentModal">
                        <i class="bi bi-file-earmark-arrow-up-fill me-2"></i> Subir Documento
                    </button>
                    <button 
                        id="btnRealizarEvaluacion"
                        type="button"
                        class="btn btn-primary shadow-sm d-flex align-items-center justify-content-center flex-grow-1 d-none"
                        data-bs-toggle="modal"
                        data-bs-target="#crearEvaluacionModal">
                        <i class="bi bi-clipboard-check-fill me-2"></i> Realizar Evaluación
                    </button>
                    <a 
                        id="btnResponderEvaluacion"
                        class="btn btn-primary btn-lg shadow-sm disabled"
                        target="_blank">
                        <i class="bi bi-file-earmark-text-fill me-2"></i> Responder Evaluación
                    </a>
                </div>
            </div>

            <div class="col-12 col-lg-4" id="chatdiv">
                <div class="card border-0 shadow-sm h-100 chat-card">
                    <div class="card-header bg-secondary bg-gradient text-white py-2">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-chat-dots me-2"></i>Chat
                        </h5>
                    </div>
                    <div class="card-body p-0 d-flex flex-column">
                        <div id="chat-container" data-user="{{ request.user.id }}" data-chat-id="{{ chat_id }}"></div>

                        <div id="chat-messages" class="flex-grow-1 p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted py-5" id="chat-placeholder">
                                <i class="bi bi-chat-square-text display-6 d-block mb-3 opacity-50"></i>
                                <p class="mb-0">El chat está listo para usar</p>
                                <small class="text-muted">Envía un mensaje para comenzar</small>
                            </div>
                        </div>

                        <div class="border-top p-3 bg-white">
                            <div class="input-group">
                                <input type="text" id="message-input" class="form-control rounded-start" placeholder="Escribe un mensaje...">
                                <button class="btn btn-primary rounded-end d-flex align-items-center" id="btn-enviar">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                            <div class="form-text text-end mt-1">
                                <small>Presiona Enter para enviar</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-3">
            <div class="modal-header bg-success text-white rounded-top-3">
                <h5 class="modal-title" id="uploadDocumentModalLabel">
                    Subir documentos, guias de estudios, etc.
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <form method="POST" action="{% url "tutoria:archivostutoria" tutoria.id %}" enctype="multipart/form-data" id="uploadForm"> 
                    {% csrf_token %} 
                    
                    {# Campo de ID de Tutoría Oculto (Asegúrate de llenarlo con JS si es necesario) #}
                    <input type="hidden" name="tutoria_id" id="tutoriaIdInput" value=""> 

                    <div class="mb-4 border p-3 rounded-3 bg-light">
                        <label for="id_archivo" class="form-label fw-semibold">
                            Seleccionar Archivos para la tutoria (PDF)
                        </label>
                        <input 
                            type="file" 
                            name="archivo" 
                            id="id_archivo" 
                            class="form-control"
                            accept="application/pdf"
                            multiple 
                        >
                        <div class="form-text text-muted">Sube uno o más archivos PDF. Puedes renombrarlos abajo.</div>
                    </div>
                        
                    <div id="archivos-seleccionados-container" class="mt-3">
                        <p class="fw-semibold small mb-1">Archivos adjuntos para nombrar:</p>
                        <ul id="lista-archivos-seleccionados" class="list-group list-group-flush border rounded-3 small">
                            <li class="list-group-item text-muted" id="initial-message">Ningún archivo seleccionado.</li>
                        </ul>
                        <div id="file-error-message" class="text-danger small mt-2 d-none"></div>
                    </div>

                    <div class="modal-footer border-0 pt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="confirmUploadBtn">Confirmar Subida</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Evaluación -->
<div class="modal fade" id="crearEvaluacionModal" tabindex="-1" aria-labelledby="crearEvaluacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <form id="crearEvaluacionForm" action="{% url "crearevaluacion" tutoria.id %}" method="post">
        {% csrf_token %}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="crearEvaluacionLabel">Crear Evaluación</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <!-- Título -->
          <div class="mb-3">
            <label for="titulo" class="form-label fw-semibold">Título de la Evaluación:</label>
            <input type="text" class="form-control" name="titulo" id="tituloEvaluacion">
          </div>

          <!-- Contenedor de preguntas -->
          <div class="container-fluid px-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0 fw-bold">Preguntas</h5>
              <button id="btnAgregarPregunta" type="button" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus-circle me-1"></i> Agregar Pregunta
              </button>
            </div>
            <div id="preguntasContainer"></div>
            <small class="text-danger d-none" id="errorPreguntas"><i class="bi bi-exclamation-circle-fill"></i>Debe agregar al menos una pregunta.</small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" id="btnenviarEvaluacion" class="btn btn-success">Guardar Evaluación</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Estilos CSS mejorados -->
<style>
/* Variables de colores para consistencia */
:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --dark-color: #212529;
}

/* Estilos generales mejorados */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Mejoras para la sección de video */
.video-card, .chat-card {
    height: 100%;
    max-height: 75vh;
}

.video-body-container {
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

.main-video-wrapper {
    height: 100%;
}

.main-video {
    object-fit: contain !important;
}

/* Controles de video mejorados */
#videoControls {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-control {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    border: none;
    transition: all 0.2s ease;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-control:hover {
    background-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.btn-control.rounded-pill {
    width: auto;
    padding-left: 16px;
    padding-right: 16px;
}

/* Indicadores de estado */
#localMicIndicator, #localCamIndicator {
    font-size: 0.7rem;
}

/* Mejoras para el chat */
#chatMessages {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Mensajes del chat mejorados */
.chat-message {
    max-width: 80%;
    word-wrap: break-word;
}

.chat-message.local {
    margin-left: auto;
    background-color: var(--primary-color);
    color: white;
    border-radius: 18px 18px 4px 18px;
}

.chat-message.remote {
    margin-right: auto;
    background-color: white;
    color: var(--dark-color);
    border-radius: 18px 18px 18px 4px;
    border: 1px solid #e9ecef;
}

.chat-message.system {
    margin: 0 auto;
    background-color: transparent;
    color: #6c757d;
    font-style: italic;
}

/* Responsive mejorado */
@media (max-width: 991.98px) {
    .video-card {
        /* Redefinición para ser más estricto */
        min-height: 250px; 
        max-height: 40vh; /* LIMITE la altura a 40% del viewport */
        margin-bottom: 0.5rem; 
    }
    
    .chat-card {
        /* Permite que el chat se estire o tenga una altura decente */
        height: 50vh; 
        min-height: 300px;
    }
    
    #localVideoContainer {
        width: 120px !important;
        height: 90px !important;
    }
    
    #videoControls {
        padding: 0.5rem !important;
        gap: 0.25rem !important;
        transform: translateX(-50%) scale(0.9);
    }
    
    .btn-control {
        width: 40px;
        height: 40px;
    }
    
    .btn-control.rounded-pill {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
    }
}

@media (max-width: 575.98px) {
    .video-card {
        /* Redefinición para ser más estricto */
        min-height: 200px;
        max-height: 35vh; /* LIMITE la altura a 35% del viewport */
    }
    
    .chat-card {
        /* Permite que el chat ocupe más espacio */
        height: 60vh; 
        min-height: 300px;
    }
    
    #localVideoContainer {
        width: 100px !important;
        height: 75px !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
    }
    
    #videoControls {
        width: 95%;
        flex-wrap: wrap;
        gap: 0.5rem !important;
    }
    
    .btn-control {
        width: 36px;
        height: 36px;
        font-size: 0.8rem;
    }

    #tutoriaActions {
        margin-top: 3rem;
    }

    #chatdiv {
        margin-top: 5rem;
    }
}

/* Estilos de Fullscreen mejorados */
#remoteVideoWrapper:-webkit-full-screen {
    width: 100% !important;
    height: 100% !important;
    background: #000;
}

#remoteVideoWrapper:fullscreen {
    width: 100% !important;
    height: 100% !important;
    background: #000;
}

/* Animaciones suaves */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Mejoras para los botones de acción */
#tutoriaActions .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

#tutoriaActions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Badges mejorados */
.badge {
    font-size: 0.7rem;
    font-weight: 500;
}

/* Mejoras para modales */
.modal-content {
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 1rem 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

/* Mejoras para la lista de archivos */
#lista-archivos-seleccionados .file-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s;
}

#lista-archivos-seleccionados .file-item:hover {
    background-color: #f8f9fa;
}

#lista-archivos-seleccionados .file-item:last-child {
    border-bottom: none;
}
</style>

<script src="{% static 'js/chat.js' %}"></script>
<script src="{% static 'js/videollamada.js' %}"></script>

{% else %}
<div class="container mt-5">
    <div class="alert alert-danger shadow-sm" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <h4 class="alert-heading mb-1">Tutoría No Disponible</h4>
                <p class="mb-0">La tutoría con ID <strong>{{ tutoria.id }}</strong> no está marcada como "En curso" o no existe.</p>
            </div>
        </div>
        <hr>
        <p class="mb-0">Por favor, verifique el estado en su panel de control.</p>
    </div>
</div>
{% endif %}
{% endblock %}