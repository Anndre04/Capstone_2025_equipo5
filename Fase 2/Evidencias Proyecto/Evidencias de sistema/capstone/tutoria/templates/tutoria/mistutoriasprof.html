{% extends 'base.html' %}
{% load static %}
{% load precios %}
{% block title %}Mis Tutorías Publicadas - Tutorías Online{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/css_tutoria/tutoria.css' %}">
<div class="container-fluid px-3 px-md-4 px-lg-5 py-4">
  
  <!-- HEADER RESPONSIVE MEJORADO -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div>
          <h1 class="h2 mb-2 fw-bold text-dark">Mis Anuncios</h1>
          <p class="text-muted mb-0">Gestiona tus anuncios y publica nuevos</p>
        </div>
        <!-- BOTÓN PUBLICAR NUEVA TUTORÍA -->
        <button class="btn btn-primary mt-3 mt-md-0" data-bs-toggle="modal" data-bs-target="#publicarTutoriaModal">
          <i class="bi bi-plus-circle me-2"></i>Publicar nuevo anuncio
        </button>
      </div>
    </div>
  </div>

  <!-- TARJETAS DE TUTORÍAS PUBLICADAS - DISEÑO MINIMALISTA -->

  {% if anuncios %}
    {% for anuncio in anuncios %}
      {% if anuncio.estado == "Activo" or anuncio.estado == "Deshabilitado" %}
      <div class="row g-4">
        <div class="col-12">
          <div class="card border-0 shadow-sm hover-card">
            <div class="card-body p-4">
              <div class="row align-items-center">
                <!-- INFORMACIÓN PRINCIPAL -->
                <div class="col-12 col-md-8 col-lg-9">
                  <div class="d-flex align-items-start mb-3">
                    <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3 flex-shrink-0" 
                        style="width: 50px; height: 50px;">
                      <i class="bi bi-calculator text-primary fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="card-title mb-1 fw-bold text-dark">{{ anuncio.titulo }}</h5>
                      <div class="d-flex align-items-center flex-wrap gap-2 mt-2">
                        <span class="badge bg-success bg-opacity-10 text-success border-0">
                          <i class="bi bi-person-check me-1"></i>Con estudiante
                        </span>
                        <span class="badge bg-primary bg-opacity-10 text-primary border-0">{{ anuncio.tutor.usuario.get_full_name }}</span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border-0">{{ anuncio.area }}</span>
                      </div>
                    </div>
                  </div>
                  <p class="text-muted mb-4">{{ anuncio.descripcion }}</p>
                  <div class="row g-3">
                    <div class="col-6 col-sm-3">
                      <div class="text-center">
                        <div class="border rounded p-3">
                          <h6 class="text-muted mb-2 small fw-normal">Precio</h6>
                          <strong class="text-success fs-6">{{ anuncio.precio|clp }}/hr</strong>
                        </div>
                      </div>
                    </div>                
                    <div class="col-6 col-sm-3">
                      <div class="text-center">
                        <div class="border rounded p-3">
                          <h6 class="text-muted mb-2 small fw-normal">Rating</h6>
                          <div>
                            <span class="text-warning">
                              <i class="bi bi-star-fill"></i>
                              <i class="bi bi-star-fill"></i>
                              <i class="bi bi-star-fill"></i>
                              <i class="bi bi-star-fill"></i>
                              <i class="bi bi-star-half"></i>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>Publicado el {{ anuncio.fecha_creacion }}
                      </small>
                      {% if anuncio.estado == "Activo" %}
                        <span class="badge bg-success bg-opacity-10 text-success border-0">
                          <i class="bi bi-check-circle me-1"></i>Activo
                        </span>
                      {% else %}
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border-0">
                          <i class="bi bi-x-circle me-1"></i>Deshabilitado
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <!-- ACCIONES -->
                <div class="col-12 col-md-4 col-lg-3 mt-4 mt-md-0">
                  <div class="d-flex flex-column gap-2">
                      <!-- Botón Activar / Desactivar -->
                      {% if anuncio.estado == "Activo" %}
                          <form method="POST" action="{% url 'tutoria:estadoanuncio' anuncio.id %}">
                              {% csrf_token %}
                              <input type="hidden" name="next" value="{{ request.get_full_path }}">
                              <input type="hidden" name="accion" value="cambiar_estado">
                              <button type="submit" class="btn btn-outline-warning w-100">
                                  <i class="bi bi-pause-circle me-2"></i>Deshabilitar
                              </button>
                          </form>
                      {% elif anuncio.estado == "Deshabilitado" %}
                          <form method="POST" action="{% url 'tutoria:estadoanuncio' anuncio.id %}">
                              {% csrf_token %}
                              <input type="hidden" name="next" value="{{ request.get_full_path }}">
                              <input type="hidden" name="accion" value="cambiar_estado">
                              <button type="submit" class="btn btn-outline-success w-100">
                                  <i class="bi bi-play-circle me-2"></i>Activar
                              </button>
                          </form>
                      {% endif %}

                      <!-- Botón Editar (siempre) -->
                      <a type="button" class="btn btn-outline-primary w-100"
                        data-bs-toggle="modal" 
                        data-bs-target="#editarTutoriaModal{{ anuncio.id }}">
                        <i class="bi bi-pencil me-2"></i>Editar
                      </a>

                      <!-- Botón Eliminar (siempre) -->
                      <form method="POST" action="{% url 'tutoria:eliminar_anuncio' anuncio.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn btn-outline-danger w-100"
                                onclick="return confirm('¿ESTÁS SEGURO? Esta acción no se puede deshacer.');">
                            <i class="bi bi-trash me-2"></i>Eliminar
                        </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Editar Anuncio -->
      <div class="modal fade" id="editarTutoriaModal{{ anuncio.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form method="POST" action="{% url 'tutoria:editaranuncio' anuncio.id %}">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title">Editar Anuncio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label>Título</label>
                  <input type="text" name="titulo" value="{{ anuncio.titulo }}" class="form-control">
                </div>
                <div class="mb-3">
                  <label>Descripción</label>
                  <textarea name="descripcion" class="form-control">{{ anuncio.descripcion }}</textarea>
                </div>
                <div class="mb-3">
                  <label>Precio</label>
                  <input type="number" name="precio" value="{{ anuncio.precio }}" class="form-control">
                </div>
                <div class="mb-3">
                  <label>Área</label>
                  <select name="area" class="form-select">
                    {% for area in areastutor %}
                      <option value="{{ area.id }}" {% if area == anuncio.area %}selected{% endif %}>{{ area.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Disponibilidades -->
                <div class="col-12 border-top pt-4 mt-2">
                      <label class="form-label fw-semibold mb-3 d-flex align-items-center">
                        <i class="bi bi-calendar-week me-2 text-primary"></i>Disponibilidad de Clases
                      </label>
                      <div class="row g-2">
                      {% for dia in dias_semana %}
                        {% get_disponibilidad_dia anuncios_disponibilidades anuncio.id dia as dia_disp %}
                        
                        <div class="col-6 col-md-4 col-lg">
                          <div class="card border day-card">
                            <div class="card-body text-center p-2">
                              <div class="form-check mb-2">
                                <input class="form-check-input day-checkbox" type="checkbox" 
                                      name="dias[]" value="{{ dia }}" 
                                      id="dia{{ dia }}{{ anuncio.id }}" 
                                      {% if dia_disp %}checked{% endif %}>
                                <label class="form-check-label fw-medium small" 
                                      for="dia{{ dia }}{{ anuncio.id }}">{{ dia }}</label>
                              </div>
                              <div class="d-flex justify-content-around">
                                <div class="form-check">
                                  <input class="form-check-input turno-check" type="checkbox" 
                                        name="turnos_{{ dia }}[]" value="M" 
                                        id="{{ dia }}Manana{{ anuncio.id }}" 
                                        {% if dia_disp and dia_disp.mañana %}checked{% endif %}>
                                  <label class="form-check-label small" for="{{ dia }}Manana{{ anuncio.id }}">M</label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input turno-check" type="checkbox" 
                                        name="turnos_{{ dia }}[]" value="T" 
                                        id="{{ dia }}Tarde{{ anuncio.id }}" 
                                        {% if dia_disp and dia_disp.tarde %}checked{% endif %}>
                                  <label class="form-check-label small" for="{{ dia }}Tarde{{ anuncio.id }}">T</label>
                                </div>
                                <div class="form-check">
                                  <input class="form-check-input turno-check" type="checkbox" 
                                        name="turnos_{{ dia }}[]" value="N" 
                                        id="{{ dia }}Noche{{ anuncio.id }}" 
                                        {% if dia_disp and dia_disp.noche %}checked{% endif %}>
                                  <label class="form-check-label small" for="{{ dia }}Noche{{ anuncio.id }}">N</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p>No tienes anuncios.</p>
  {% endif %}
</div>

<!-- MODAL PARA PUBLICAR NUEVA TUTORÍA  -->
<div class="modal fade" id="publicarTutoriaModal" tabindex="-1" aria-labelledby="publicarTutoriaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-dark" id="publicarTutoriaModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Publicar Nueva Tutoría
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-0">
        <form method="POST" action="{% url 'tutoria:publicartutoria' user.id %}">
          {% csrf_token %}
          <div class="row g-3">
            <!-- Título -->
            <div class="col-12">
              <label class="form-label fw-semibold">Título de la Tutoría</label>
              <input type="text" name="titulo" class="form-control border" placeholder="Ej: Matemáticas Avanzadas - Álgebra Lineal" required>
            </div>

            <!-- Descripción -->
            <div class="col-12">
              <label class="form-label fw-semibold">Descripción</label>
              <textarea name="descripcion" class="form-control border" rows="3" placeholder="Describe los temas que cubrirás en la tutoría..." required></textarea>
            </div>

            <!-- Precio -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Precio por hora</label>
              <div class="input-group">
                <span class="input-group-text bg-light border">$</span>
                <input type="number" name="precio" class="form-control border-start-0" placeholder="25" value="25" min="0" required>
              </div>
            </div>

            <!-- Duración -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Duración</label>
              <select name="duracion" class="form-select border" disabled>
                <option value="60" selected>60 minutos</option>
              </select>
            </div>

            <!-- Área de conocimiento -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Área de Conocimiento</label>
              <select name="area" class="form-select border" required>
                {% for at in areastutor %}
                  <option value="{{ at.id }}">{{ at.area }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Disponibilidad -->
            <div class="col-12 border-top pt-4 mt-2">
              <label class="form-label fw-semibold mb-3 d-flex align-items-center">
                <i class="bi bi-calendar-week me-2 text-primary"></i>Disponibilidad de Clases
              </label>
              <p class="text-muted small mb-4">Selecciona los días y turnos en los que estás disponible</p>

              <div class="row g-2">
                {% for dia in dias_semana %}
                <div class="col-6 col-md-4 col-lg">
                    <div class="card border day-card">
                        <div class="card-body text-center p-2">
                            <div class="form-check mb-2">
                                <input class="form-check-input day-checkbox" type="checkbox" name="dias[]" value="{{ dia }}" id="dia{{ dia }}" checked>
                                <label class="form-check-label fw-medium small" for="dia{{ dia }}">{{ dia }}</label>
                            </div>
                            <div class="d-flex justify-content-around">
                                <div class="form-check">
                                    <input class="form-check-input turno-check" type="checkbox" name="turnos_{{ dia }}[]" value="M" id="{{ dia }}Manana" checked>
                                    <label class="form-check-label small" for="{{ dia }}Manana" title="Mañana">M</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input turno-check" type="checkbox" name="turnos_{{ dia }}[]" value="T" id="{{ dia }}Tarde" checked>
                                    <label class="form-check-label small" for="{{ dia }}Tarde" title="Tarde">T</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input turno-check" type="checkbox" name="turnos_{{ dia }}[]" value="N" id="{{ dia }}Noche">
                                    <label class="form-check-label small" for="{{ dia }}Noche" title="Noche">N</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
              </div>
            </div>

            <!-- Resumen -->
            <div class="alert alert-light border mt-3 mb-0">
              <div class="d-flex align-items-center">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <small class="text-muted">
                  <span id="resumenDisponibilidad">Disponible de Lunes a Viernes en turnos de Mañana y Tarde</span>
                </small>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Publicar Tutoría</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/tutoria.js' %}"></script>
{% endblock %}